<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgroCota ‚Äî Preencher Planilha</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=IBM+Plex+Mono:wght@400;600&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --green-deep: #0f2d13;
    --green-mid: #1a4d20;
    --green-bright: #2e7d32;
    --green-light: #4caf50;
    --green-pale: #e8f5e9;
    --green-accent: #69f0ae;
    --amber: #f59e0b;
    --amber-pale: #fffbeb;
    --red: #dc2626;
    --red-pale: #fff1f1;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-muted: #94a3b8;
    --border: #e2e8f0;
    --surface: #ffffff;
    --page-bg: #f0f4f0;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Sora', sans-serif;
    background: var(--page-bg);
    color: var(--text-primary);
    min-height: 100vh;
    background-image: 
      radial-gradient(ellipse at 20% 0%, rgba(46,125,50,0.08) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 100%, rgba(15,45,19,0.06) 0%, transparent 60%);
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .site-header {
    background: var(--green-deep);
    padding: 0 24px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 20px rgba(0,0,0,0.3);
  }
  .header-inner {
    max-width: 1200px;
    margin: 0 auto;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo-icon {
    width: 34px;
    height: 34px;
    background: var(--green-bright);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }
  .logo-text {
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    color: #ffffff;
    letter-spacing: -0.3px;
  }
  .logo-text span {
    color: var(--green-accent);
  }
  .header-badge {
    background: rgba(105,240,174,0.15);
    border: 1px solid rgba(105,240,174,0.3);
    color: var(--green-accent);
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .page-wrap {
    max-width: 1200px;
    margin: 0 auto;
    padding: 32px 16px 80px;
  }

  /* ‚îÄ‚îÄ ESTADOS ‚îÄ‚îÄ */
  .state-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 60px 32px;
    text-align: center;
    margin-top: 40px;
  }
  .state-icon { font-size: 48px; margin-bottom: 16px; }
  .state-title { font-size: 22px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
  .state-sub { font-size: 14px; color: var(--text-secondary); line-height: 1.6; }
  .spinner {
    width: 40px; height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--green-bright);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
  .hero {
    background: var(--green-mid);
    border-radius: 16px;
    padding: 28px 28px 24px;
    color: #ffffff;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -30px; right: -30px;
    width: 160px; height: 160px;
    background: rgba(105,240,174,0.06);
    border-radius: 50%;
  }
  .hero::after {
    content: '';
    position: absolute;
    bottom: -20px; left: 60px;
    width: 100px; height: 100px;
    background: rgba(255,255,255,0.04);
    border-radius: 50%;
  }
  .hero-eyebrow {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--green-accent);
    margin-bottom: 8px;
  }
  .hero-title {
    font-family: 'DM Serif Display', serif;
    font-size: 26px;
    line-height: 1.2;
    margin-bottom: 16px;
  }
  .hero-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .hero-chip {
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.18);
    color: rgba(255,255,255,0.9);
    font-size: 12px;
    font-weight: 500;
    padding: 4px 12px;
    border-radius: 20px;
  }
  .hero-chip.highlight {
    background: rgba(105,240,174,0.2);
    border-color: rgba(105,240,174,0.4);
    color: var(--green-accent);
    font-weight: 700;
  }

  /* ‚îÄ‚îÄ INSTRUCOES ‚îÄ‚îÄ */
  .info-banner {
    background: var(--amber-pale);
    border: 1px solid #fde68a;
    border-radius: 12px;
    padding: 14px 18px;
    display: flex;
    gap: 12px;
    align-items: flex-start;
    margin-bottom: 20px;
    font-size: 13px;
    color: #92400e;
    line-height: 1.5;
  }
  .info-banner-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }

  /* ‚îÄ‚îÄ FORMUL√ÅRIO DE IDENTIFICA√á√ÉO ‚îÄ‚îÄ */
  .form-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 20px;
  }
  .form-card-head {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .form-card-head-icon {
    width: 30px; height: 30px;
    background: var(--green-pale);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
  }
  .form-card-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--text-primary);
  }
  .form-card-body { padding: 20px; }
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }
  .form-grid.three { grid-template-columns: 1fr 1fr 1fr; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group.full { grid-column: 1 / -1; }
  label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.7px;
  }
  input, select, textarea {
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 9px 12px;
    font-family: 'Sora', sans-serif;
    font-size: 13px;
    color: var(--text-primary);
    background: var(--surface);
    transition: border-color 0.15s;
    outline: none;
    width: 100%;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--green-bright);
    box-shadow: 0 0 0 3px rgba(46,125,50,0.08);
  }
  textarea { resize: vertical; min-height: 80px; }

  /* ‚îÄ‚îÄ TABELA DE PRODUTOS ‚îÄ‚îÄ */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
  }
  .section-title {
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    color: var(--text-primary);
  }
  .section-count {
    background: var(--green-pale);
    color: var(--green-bright);
    font-size: 12px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 20px;
  }

  /* ‚îÄ‚îÄ CATEGORIA ‚îÄ‚îÄ */
  .category-block { margin-bottom: 24px; }
  .category-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--green-bright);
    background: var(--green-pale);
    padding: 5px 12px;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 10px;
  }

  /* ‚îÄ‚îÄ TABELA ‚îÄ‚îÄ */
  .products-table {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .table-header {
    display: grid;
    grid-template-columns: 2fr 1.5fr 1fr 0.8fr 0.8fr 1fr 1.2fr 1.5fr;
    gap: 12px;
    padding: 12px 16px;
    background: #f8fafc;
    border-bottom: 2px solid var(--border);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-muted);
  }
  .table-row {
    display: grid;
    grid-template-columns: 2fr 1.5fr 1fr 0.8fr 0.8fr 1fr 1.2fr 1.5fr;
    gap: 12px;
    padding: 14px 16px;
    border-bottom: 1px solid #f1f5f9;
    align-items: center;
    transition: background 0.15s;
  }
  .table-row:hover {
    background: #fafbfc;
  }
  .table-row:last-child {
    border-bottom: none;
  }
  .table-cell {
    font-size: 13px;
    color: var(--text-primary);
  }
  .table-cell.product-name {
    font-weight: 600;
    color: var(--green-deep);
  }
  .table-cell.ia-cell {
    font-size: 11px;
    color: var(--text-secondary);
  }
  .pill {
    font-size: 10px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 20px;
    display: inline-block;
  }
  .pill-cat { background: #f1f5f9; color: #64748b; }
  .pill-dose { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
  .pill-tech { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }

  /* ‚îÄ‚îÄ INPUT DE VALOR ‚îÄ‚îÄ */
  .price-input-wrap {
    display: flex;
    align-items: center;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    background: var(--surface);
    overflow: hidden;
    transition: border-color 0.15s;
    max-width: 140px;
  }
  .price-input-wrap:focus-within {
    border-color: var(--green-bright);
    box-shadow: 0 0 0 3px rgba(46,125,50,0.08);
  }
  .price-prefix {
    padding: 8px 8px;
    font-size: 12px;
    font-weight: 700;
    color: var(--green-bright);
    background: var(--green-pale);
    border-right: 1.5px solid var(--border);
    font-family: 'IBM Plex Mono', monospace;
  }
  .price-input {
    border: none !important;
    box-shadow: none !important;
    width: 100%;
    padding: 8px 8px !important;
    font-family: 'IBM Plex Mono', monospace !important;
    font-weight: 600 !important;
    font-size: 13px !important;
    color: var(--text-primary) !important;
    background: transparent !important;
  }
  .price-input:focus { border: none !important; box-shadow: none !important; }
  .price-suffix {
    padding: 8px 8px;
    font-size: 10px;
    font-weight: 600;
    color: var(--text-muted);
    white-space: nowrap;
    background: #f8fafc;
    border-left: 1.5px solid var(--border);
  }

  /* ‚îÄ‚îÄ TOTALIZADOR ‚îÄ‚îÄ */
  .totals-bar {
    background: var(--green-deep);
    border-radius: 14px;
    padding: 20px 24px;
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 20px;
  }
  .totals-label {
    font-size: 12px;
    color: rgba(255,255,255,0.6);
    font-weight: 500;
    margin-bottom: 4px;
  }
  .totals-value {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 26px;
    font-weight: 600;
    color: var(--green-accent);
  }
  .totals-right {
    display: flex;
    gap: 24px;
  }
  .totals-sub {
    text-align: right;
  }
  .totals-sub-label {
    font-size: 11px;
    color: rgba(255,255,255,0.5);
    margin-bottom: 3px;
  }
  .totals-sub-val {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 16px;
    font-weight: 600;
    color: rgba(255,255,255,0.9);
  }

  /* ‚îÄ‚îÄ BOT√ÉO SUBMIT ‚îÄ‚îÄ */
  .submit-section {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-end;
  }
  .btn-submit {
    background: var(--green-bright);
    color: #ffffff;
    border: none;
    border-radius: 10px;
    padding: 14px 32px;
    font-family: 'Sora', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.15s, transform 0.1s;
    min-width: 200px;
    justify-content: center;
  }
  .btn-submit:hover { background: #27662b; }
  .btn-submit:active { transform: scale(0.98); }
  .btn-submit:disabled { background: #94a3b8; cursor: not-allowed; transform: none; }
  .btn-submit .spinner-sm {
    width: 18px; height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    display: none;
  }
  .btn-submit.loading .spinner-sm { display: block; }
  .btn-submit.loading .btn-text { display: none; }

  /* ‚îÄ‚îÄ SUCESSO ‚îÄ‚îÄ */
  #success-view {
    display: none;
  }
  .success-card {
    background: var(--surface);
    border: 1px solid #bbf7d0;
    border-radius: 20px;
    padding: 60px 32px;
    text-align: center;
    margin-top: 20px;
  }
  .success-icon-wrap {
    width: 80px; height: 80px;
    background: var(--green-pale);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 38px;
    margin: 0 auto 20px;
  }
  .success-title {
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    color: var(--green-mid);
    margin-bottom: 10px;
  }
  .success-sub {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.7;
    max-width: 400px;
    margin: 0 auto 24px;
  }
  .success-summary {
    display: inline-flex;
    flex-direction: column;
    background: var(--green-pale);
    border-radius: 12px;
    padding: 16px 28px;
    gap: 4px;
  }
  .success-summary-label { font-size: 11px; color: var(--green-bright); font-weight: 600; text-transform: uppercase; }
  .success-summary-val { font-family: 'IBM Plex Mono', monospace; font-size: 22px; font-weight: 600; color: var(--green-deep); }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast-container {
    position: fixed;
    bottom: 24px; right: 24px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 9999;
  }
  .toast {
    background: #1e293b;
    color: #ffffff;
    padding: 12px 18px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 500;
    max-width: 320px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.2);
    animation: toastIn 0.25s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .toast.success { background: #14532d; border-left: 3px solid var(--green-accent); }
  .toast.error   { background: #7f1d1d; border-left: 3px solid #f87171; }
  @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 1024px) {
    .table-header, .table-row {
      grid-template-columns: 2fr 1.2fr 0.8fr 0.8fr 1fr 1.5fr;
    }
    .table-cell.ia-cell,
    .table-cell.obs-cell {
      display: none;
    }
  }

  @media (max-width: 768px) {
    .form-grid, .form-grid.three { grid-template-columns: 1fr; }
    .form-group.full { grid-column: 1; }
    .totals-bar { flex-direction: column; align-items: flex-start; }
    .totals-right { flex-direction: column; gap: 12px; }
    .hero-title { font-size: 20px; }
    
    .table-header, .table-row {
      grid-template-columns: 1.5fr 0.8fr 1fr;
    }
    .table-cell.subcat-cell,
    .table-cell.dose-cell,
    .table-cell.aplic-cell {
      display: none;
    }
  }
</style>
</head>
<body>

<header class="site-header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">üåø</div>
      <span class="logo-text">Agro<span>Cota</span></span>
    </div>
    <div class="header-badge">Fornecedor</div>
  </div>
</header>

<div class="page-wrap">

  <!-- LOADING -->
  <div id="loading-view" class="state-card">
    <div class="spinner"></div>
    <div class="state-title">Carregando planilha...</div>
    <div class="state-sub">Buscando os dados da cota√ß√£o.</div>
  </div>

  <!-- ERRO -->
  <div id="error-view" class="state-card" style="display:none;">
    <div class="state-icon">‚ö†Ô∏è</div>
    <div class="state-title">Planilha n√£o encontrada</div>
    <div class="state-sub" id="error-msg">O link pode estar expirado ou inv√°lido. Entre em contato com o consultor.</div>
  </div>

  <!-- FORMUL√ÅRIO PRINCIPAL -->
  <div id="main-view" style="display:none;">

    <!-- Hero -->
    <div class="hero">
      <div class="hero-eyebrow">üìã Planilha AgroCota</div>
      <div class="hero-title" id="hero-title">Carregando...</div>
      <div class="hero-meta">
        <span class="hero-chip" id="hero-fazenda">‚Äî</span>
        <span class="hero-chip" id="hero-safra">‚Äî</span>
        <span class="hero-chip highlight" id="hero-area">‚Äî</span>
      </div>
    </div>

    <!-- Instru√ß√µes -->
    <div class="info-banner">
      <span class="info-banner-icon">üí°</span>
      <div>Preencha sua <strong>identifica√ß√£o</strong> e insira o <strong>valor R$/ha</strong> para cada produto. Campos sem pre√ßo ser√£o ignorados. Ao finalizar, clique em <strong>"Enviar Proposta"</strong>.</div>
    </div>

    <!-- Identifica√ß√£o do fornecedor -->
    <div class="form-card">
      <div class="form-card-head">
        <div class="form-card-head-icon">üè¢</div>
        <div class="form-card-title">Identifica√ß√£o do Fornecedor</div>
      </div>
      <div class="form-card-body">
        <div class="form-grid three">
          <div class="form-group">
            <label>Empresa *</label>
            <input type="text" id="empresa" placeholder="Nome da empresa" required>
          </div>
          <div class="form-group">
            <label>Respons√°vel *</label>
            <input type="text" id="responsavel" placeholder="Seu nome completo" required>
          </div>
          <div class="form-group">
            <label>Telefone / WhatsApp</label>
            <input type="tel" id="telefone" placeholder="(00) 00000-0000">
          </div>
          <div class="form-group">
            <label>E-mail</label>
            <input type="email" id="email" placeholder="seu@email.com.br">
          </div>
          <div class="form-group">
            <label>Validade da Proposta</label>
            <input type="date" id="validade_proposta">
          </div>
          <div class="form-group full">
            <label>Observa√ß√µes Gerais</label>
            <textarea id="observacoes" placeholder="Condi√ß√µes de pagamento, prazo de entrega, descontos por volume..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Produtos -->
    <div class="section-header">
      <div class="section-title">Produtos da Planilha</div>
      <div class="section-count" id="items-count">0 itens</div>
    </div>

    <div id="items-container"></div>

    <!-- Totalizador -->
    <div class="totals-bar" id="totals-bar" style="display:none;">
      <div>
        <div class="totals-label">Total estimado da proposta</div>
        <div class="totals-value" id="total-val">R$ 0,00</div>
      </div>
      <div class="totals-right">
        <div class="totals-sub">
          <div class="totals-sub-label">√Årea total (ha)</div>
          <div class="totals-sub-val" id="area-total">‚Äî</div>
        </div>
        <div class="totals-sub">
          <div class="totals-sub-label">Itens preenchidos</div>
          <div class="totals-sub-val" id="filled-count">0 / 0</div>
        </div>
      </div>
    </div>

    <!-- Submit -->
    <div class="submit-section">
      <button class="btn-submit" id="btn-submit" onclick="submitProposta()">
        <div class="spinner-sm"></div>
        <span class="btn-text">üöÄ Enviar Proposta</span>
      </button>
    </div>

  </div><!-- /main-view -->

  <!-- SUCESSO FINAL -->
  <div id="success-view">
    <div class="success-card">
      <div class="success-icon-wrap">üéâ</div>
      <div class="success-title">Proposta enviada com sucesso!</div>
      <div class="success-sub">O consultor respons√°vel foi notificado e ir√° analisar sua proposta. Obrigado pela participa√ß√£o!</div>
      <div class="success-summary">
        <div class="success-summary-label">Total enviado</div>
        <div class="success-summary-val" id="success-total">R$ ‚Äî</div>
      </div>
    </div>
  </div>

</div><!-- /page-wrap -->

<div class="toast-container" id="toast-container"></div>

<script>
/* ‚îÄ‚îÄ CONFIG SUPABASE ‚îÄ‚îÄ */
const SUPABASE_URL = 'https://sb_publishable_3HDU_nViFfOubXqNplV5ow_8FV0Ix0r.supabase.co';
const SUPABASE_KEY = 'sb_publishable_3HDU_nViFfOubXqNplV5ow_8FV0Ix0r';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ‚îÄ‚îÄ ESTADO ‚îÄ‚îÄ */
let cotacaoData  = null;
let produtosPlanilha = [];

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
function getToken() {
  const params = new URLSearchParams(window.location.search);
  return params.get('token') || params.get('t') || '';
}

function fmt(v) {
  return Number(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
  el.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

function show(id)  { document.getElementById(id).style.display = 'block'; }
function hide(id)  { document.getElementById(id).style.display = 'none'; }

/* ‚îÄ‚îÄ CARREGAR DADOS ‚îÄ‚îÄ */
async function loadPlanilha() {
  const token = getToken();

  if (!token) {
    hide('loading-view');
    show('error-view');
    document.getElementById('error-msg').textContent = 'Nenhum token encontrado na URL.';
    return;
  }

  try {
    // Busca a cota√ß√£o pelo approval_token
    const { data: cotacao, error: errCot } = await _supabase
      .from('cotacoes')
      .select('id, titulo, status, area_ha, tipo_safra, fazendas(nome, municipio, estado)')
      .eq('approval_token', token)
      .single();

    if (errCot || !cotacao) {
      throw new Error('Cota√ß√£o n√£o encontrada para este token.');
    }

    cotacaoData = cotacao;

    // Busca os itens da cota√ß√£o (produtos da planilha)
    const { data: itens, error: errItens } = await _supabase
      .from('itens_cotacao')
      .select('*')
      .eq('cotacao_id', cotacao.id)
      .order('categoria');

    if (errItens) throw new Error('Erro ao buscar produtos: ' + errItens.message);

    produtosPlanilha = itens || [];

    if (produtosPlanilha.length === 0) {
      hide('loading-view');
      show('error-view');
      document.getElementById('error-msg').textContent =
        'Esta planilha ainda n√£o possui produtos cadastrados.';
      return;
    }

    renderForm(cotacao, produtosPlanilha);
    hide('loading-view');
    show('main-view');

  } catch (err) {
    hide('loading-view');
    show('error-view');
    document.getElementById('error-msg').textContent = err.message || 'Erro inesperado.';
  }
}

/* ‚îÄ‚îÄ RENDERIZAR FORMUL√ÅRIO ‚îÄ‚îÄ */
function renderForm(cotacao, produtos) {
  // Hero
  document.getElementById('hero-title').textContent = cotacao.titulo || 'Planilha sem t√≠tulo';

  const fazenda = cotacao.fazendas;
  document.getElementById('hero-fazenda').textContent =
    fazenda ? `üè° ${fazenda.nome}` + (fazenda.municipio ? ` ‚Äî ${fazenda.municipio}/${fazenda.estado || ''}` : '') : '‚Äî';

  document.getElementById('hero-safra').textContent =
    `üåæ ${cotacao.tipo_safra === 'safrinha' ? 'Safrinha' : 'Safra'}`;

  document.getElementById('hero-area').textContent = 
    cotacao.area_ha ? `üìê ${cotacao.area_ha} ha` : 'üìê √Årea n√£o definida';

  // Contador
  document.getElementById('items-count').textContent = `${produtos.length} ite${produtos.length !== 1 ? 'ns' : 'm'}`;
  document.getElementById('area-total').textContent = cotacao.area_ha ? `${cotacao.area_ha} ha` : '‚Äî';

  // Agrupar por categoria
  const grupos = {};
  produtos.forEach(item => {
    const cat = item.categoria || 'Geral';
    if (!grupos[cat]) grupos[cat] = [];
    grupos[cat].push(item);
  });

  const container = document.getElementById('items-container');
  container.innerHTML = '';

  Object.entries(grupos).forEach(([cat, grupoProdutos]) => {
    const block = document.createElement('div');
    block.className = 'category-block';

    let html = `<div class="category-label">${cat}</div>`;
    html += `<div class="products-table">`;
    
    // Header da tabela
    html += `
      <div class="table-header">
        <div>Produto</div>
        <div class="ia-cell">I.A. / Fonte</div>
        <div>Subcategoria</div>
        <div>Dose/ha</div>
        <div>Aplic.</div>
        <div>Est√°dio</div>
        <div>Valor R$/ha</div>
        <div class="obs-cell">Observa√ß√£o</div>
      </div>`;

    // Linhas de produtos
    grupoProdutos.forEach(item => {
      const subcatInfo = item.subcategoria || '‚Äî';
      const doseInfo = item.dose_ha ? `${item.dose_ha} ${item.unidade || ''}` : '‚Äî';
      const aplicInfo = item.n_aplicacoes || '‚Äî';
      const estagioInfo = item.estagio || '‚Äî';
      const iaInfo = item.ia_fonte || '‚Äî';

      html += `
        <div class="table-row" id="row-${item.id}">
          <div class="table-cell product-name">${item.produto_nome}</div>
          <div class="table-cell ia-cell">${iaInfo}</div>
          <div class="table-cell subcat-cell">
            <span class="pill pill-cat">${subcatInfo}</span>
          </div>
          <div class="table-cell dose-cell">
            <span class="pill pill-dose">${doseInfo}</span>
          </div>
          <div class="table-cell aplic-cell">${aplicInfo}</div>
          <div class="table-cell">
            ${estagioInfo !== '‚Äî' ? `<span class="pill pill-tech">${estagioInfo}</span>` : '‚Äî'}
          </div>
          <div class="table-cell">
            <div class="price-input-wrap">
              <div class="price-prefix">R$</div>
              <input
                type="number"
                class="price-input"
                id="price-${item.id}"
                placeholder="0,00"
                min="0"
                step="0.01"
                oninput="updateTotals()"
              >
              <div class="price-suffix">/ha</div>
            </div>
          </div>
          <div class="table-cell obs-cell">
            <input
              type="text"
              id="obs-${item.id}"
              placeholder="Obs..."
              style="border: 1.5px solid var(--border); border-radius: 6px; padding: 6px 8px; font-size: 12px; width: 100%;"
            >
          </div>
        </div>`;
    });

    html += `</div>`; // fecha products-table
    block.innerHTML = html;
    container.appendChild(block);
  });

  document.getElementById('totals-bar').style.display = 'flex';
  updateTotals();
}

/* ‚îÄ‚îÄ TOTAIS ‚îÄ‚îÄ */
function updateTotals() {
  let total = 0;
  let filled = 0;
  const total_itens = produtosPlanilha.length;

  produtosPlanilha.forEach(item => {
    const v = parseFloat(document.getElementById(`price-${item.id}`)?.value || '0');
    if (v > 0) { total += v; filled++; }
  });

  document.getElementById('total-val').textContent = fmt(total);
  document.getElementById('filled-count').textContent = `${filled} / ${total_itens}`;
}

/* ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ */
async function submitProposta() {
  const empresa     = document.getElementById('empresa').value.trim();
  const responsavel = document.getElementById('responsavel').value.trim();
  const telefone    = document.getElementById('telefone').value.trim();
  const email       = document.getElementById('email').value.trim();
  const validade    = document.getElementById('validade_proposta').value;
  const observacoes = document.getElementById('observacoes').value.trim();

  if (!empresa || !responsavel) {
    toast('Preencha o nome da empresa e o respons√°vel.', 'error');
    return;
  }

  // Montar itens com pre√ßos
  const itensJson = produtosPlanilha.map(item => {
    const v = parseFloat(document.getElementById(`price-${item.id}`)?.value || '0');
    const obs = document.getElementById(`obs-${item.id}`)?.value.trim() || '';
    return {
      item_id:       item.id,
      produto_nome:  item.produto_nome,
      categoria:     item.categoria,
      subcategoria:  item.subcategoria,
      ia_fonte:      item.ia_fonte,
      dose_ha:       item.dose_ha,
      unidade:       item.unidade,
      n_aplicacoes:  item.n_aplicacoes,
      estagio:       item.estagio,
      valor_ha:      v > 0 ? v : null,
      obs_item:      obs || null,
    };
  });

  const preenchidos = itensJson.filter(i => i.valor_ha != null);
  if (preenchidos.length === 0) {
    toast('Preencha ao menos um valor antes de enviar.', 'error');
    return;
  }

  const totalProposta = preenchidos.reduce((acc, i) => acc + (i.valor_ha || 0), 0);

  const btn = document.getElementById('btn-submit');
  btn.disabled = true;
  btn.classList.add('loading');

  try {
    // Inserir na tabela propostas_fornecedor
    const { error: errInsert } = await _supabase
      .from('propostas_fornecedor')
      .insert({
        cotacao_id:       cotacaoData.id,
        token_cotacao:    getToken(),
        empresa_nome:     empresa,
        responsavel_nome: responsavel,
        telefone:         telefone || null,
        email:            email || null,
        validade_proposta: validade || null,
        observacoes:      observacoes || null,
        itens_json:       itensJson,
        total_proposta:   totalProposta,
        user_agent:       navigator.userAgent,
        lida:             false,
      });

    if (errInsert) throw new Error(errInsert.message);

    // Exibir sucesso
    hide('main-view');
    document.getElementById('success-total').textContent = fmt(totalProposta);
    show('success-view');
    window.scrollTo({ top: 0, behavior: 'smooth' });

  } catch (err) {
    toast('Erro ao enviar: ' + (err.message || 'Tente novamente.'), 'error');
    btn.disabled = false;
    btn.classList.remove('loading');
  }
}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
window.addEventListener('DOMContentLoaded', loadPlanilha);
</script>
</body>
</html>
