<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agrocota — Cotação Fornecedor</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* --- O SEU CSS COMPLETO MANTIDO --- */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --navy: #0d2137; --navy-mid: #163350; --blue-700: #1565c0; --blue-600: #1976d2;
  --blue-400: #42a5f5; --blue-100: #e3f2fd; --blue-50: #f0f7ff; --green-700: #2e7d32;
  --green-600: #388e3c; --green-100: #e8f5e9; --green-50: #f4faf4; --red-600: #c62828;
  --gray-900: #111827; --gray-700: #374151; --gray-600: #4b5563; --gray-500: #6b7280;
  --gray-400: #9ca3af; --gray-300: #d1d5db; --gray-200: #e5e7eb; --gray-100: #f3f4f6;
  --gray-50: #f9fafb; --bg: #edf2f7; --radius: 8px; --radius-lg: 12px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,.08);
}
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--gray-900); min-height: 100vh; font-size: 14px; }
.header { background: var(--navy); height: 60px; padding: 0 36px; display: flex; align-items: center; justify-content: space-between; }
.brand { display: flex; align-items: center; gap: 14px; }
.brand-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 17px; color: #fff; }
.brand-tag { font-size: 11px; color: rgba(255,255,255,.45); }
.main { max-width: 1440px; margin: 0 auto; padding: 24px 20px; }
.instrucao { background: var(--blue-50); border: 1.5px solid #90caf9; border-radius: var(--radius); padding: 16px; margin-bottom: 20px; color: var(--blue-700); }
.card { background: #fff; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200); overflow: hidden; }
.card-head-blue { background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%); padding: 22px 30px; color: #fff; }
.card-head-blue h2 { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 18px; }
.card-body { padding: 22px; }
.forn-form { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius); padding: 18px; margin-bottom: 22px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label { font-size: 11px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; }
.form-input { height: 38px; padding: 0 11px; border: 1.5px solid var(--gray-200); border-radius: var(--radius); }
.table-wrap { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--gray-200); }
table { width: 100%; border-collapse: collapse; min-width: 1000px; }
th { padding: 12px; background: var(--gray-50); text-align: left; font-size: 11px; color: var(--gray-500); border-bottom: 2px solid var(--gray-200); }
td { padding: 12px; border-bottom: 1px solid var(--gray-100); }
.price-col { background: var(--green-50); width: 150px; }
.input-price { height: 38px; width: 100%; padding: 0 10px; border: 2px solid #a5d6a7; border-radius: var(--radius); font-weight: 700; text-align: right; color: var(--green-700); }
.total-bar { background: var(--green-50); border: 2px solid #a5d6a7; border-radius: var(--radius); padding: 16px 22px; display: flex; align-items: center; justify-content: space-between; margin-top: 18px; }
.total-value { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 24px; color: var(--green-700); }
.btn-primary-blue { background: var(--blue-700); color: #fff; border: none; padding: 12px 24px; border-radius: var(--radius); font-weight: 700; cursor: pointer; }
.success-banner { display: none; background: var(--green-100); border: 2px solid #a5d6a7; padding: 20px; text-align: center; border-radius: var(--radius); margin-top: 20px; }
.notif { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: var(--radius); color: #fff; font-weight: 600; z-index: 1000; }
.notif.success { background: var(--green-600); }
.notif.error { background: var(--red-600); }
#forn-empty { display: none; text-align: center; padding: 40px; color: var(--gray-500); }
</style>
</head>
<body>

<header class="header">
  <div class="brand">
    <div class="brand-name">AgroCota</div>
    <div class="brand-tag">Cotação Fornecedor</div>
  </div>
</header>

<div class="main">
  <div class="instrucao">
    <strong>Instrução:</strong> Preencha os preços na coluna verde. O sistema calculará o total e avisará o consultor automaticamente no envio.
  </div>

  <div class="card">
    <div class="card-head-blue">
      <h2 id="titulo-pagina">Carregando Cotação...</h2>
    </div>

    <div class="card-body">
      <div class="forn-form">
        <div class="form-group">
          <label class="form-label">Empresa *</label>
          <input type="text" id="forn-empresa" class="form-input" placeholder="Sua revenda/empresa">
        </div>
        <div class="form-group">
          <label class="form-label">Responsável *</label>
          <input type="text" id="forn-contato" class="form-input" placeholder="Seu nome">
        </div>
        <div class="form-group">
          <label class="form-label">WhatsApp</label>
          <input type="text" id="forn-tel" class="form-input" placeholder="(00) 00000-0000">
        </div>
        <div class="form-group">
          <label class="form-label">E-mail</label>
          <input type="text" id="forn-email" class="form-input" placeholder="email@empresa.com">
        </div>
      </div>

      <div id="forn-empty">Nenhum produto encontrado para esta cotação.</div>

      <div class="table-wrap">
        <table id="tabela-produtos">
          <thead>
            <tr>
              <th>Produto</th>
              <th>Dose/ha</th>
              <th>Observações</th>
              <th class="price-col">Preço (R$/ha)</th>
            </tr>
          </thead>
          <tbody id="forn-body"></tbody>
        </table>
      </div>

      <div class="total-bar">
        <div><strong>Total da Proposta</strong></div>
        <div class="total-value" id="total-val">R$ 0,00</div>
      </div>

      <div id="btn-row" style="margin-top:24px; text-align:right;">
        <button class="btn-primary-blue" onclick="submitCotacao()">✓ Enviar Proposta ao Consultor</button>
      </div>

      <div class="success-banner" id="success-banner">
        <h3>✓ Proposta Enviada!</h3>
        <p>Obrigado. O consultor acaba de ser notificado no aplicativo.</p>
      </div>
    </div>
  </div>
</div>

<script>
/* --- CONFIGURAÇÃO SUPABASE --- */
const SUPABASE_URL = 'https://sb_publishable_3HDU_nViFfOubXqNplV5ow_8FV0Ix0r.supabase.co'; 
const SUPABASE_KEY = 'sb_publishable_3HDU_nViFfOubXqNplV5ow_8FV0Ix0r'; 
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let products = [];
let localPrices = {};

// 1. CARREGAR DADOS DO BANCO
async function loadData() {
  const urlParams = new URLSearchParams(window.location.search);
  const cotacaoId = urlParams.get('id');

  if (!cotacaoId) {
    document.getElementById('titulo-pagina').innerText = "Link Inválido";
    notify('ID da cotação ausente na URL', 'error');
    return;
  }

  const { data, error } = await _supabase
    .from('itens_cotacao')
    .select('*')
    .eq('cotacao_id', cotacaoId);

  if (error) {
    notify('Erro ao carregar dados', 'error');
    return;
  }

  if (data.length === 0) {
    document.getElementById('forn-empty').style.display = 'block';
    document.getElementById('tabela-produtos').style.display = 'none';
  }

  products = data;
  document.getElementById('titulo-pagina').innerText = "Responder Cotação";
  renderTable();
}

// 2. DESENHAR TABELA
function renderTable() {
  const tbody = document.getElementById('forn-body');
  tbody.innerHTML = products.map(p => `
    <tr>
      <td><strong>${p.produto_nome}</strong></td>
      <td>${p.dose_ha || ''} ${p.unidade || ''}</td>
      <td style="color: #666; font-size: 12px;">${p.obs || '—'}</td>
      <td class="price-col">
        <input type="number" class="input-price" 
          oninput="onPriceInput('${p.id}', this.value)" 
          placeholder="0,00">
      </td>
    </tr>
  `).join('');
}

function onPriceInput(id, val) {
  localPrices[id] = parseFloat(val) || 0;
  calcTotal();
}

function calcTotal() {
  const total = Object.values(localPrices).reduce((s, v) => s + v, 0);
  document.getElementById('total-val').textContent = 'R$ ' + total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
}

// 3. ENVIAR E NOTIFICAR
async function submitCotacao() {
  const empresa = document.getElementById('forn-empresa').value.trim();
  const contato = document.getElementById('forn-contato').value.trim();
  
  const urlParams = new URLSearchParams(window.location.search);
  const cotacaoId = urlParams.get('id');
  const token = urlParams.get('token');

  if (!empresa || !contato) {
    notify('Preencha os campos obrigatórios (*)', 'error');
    return;
  }

  const total = Object.values(localPrices).reduce((s, v) => s + v, 0);
  if (total === 0) {
    notify('Preencha pelo menos um preço', 'error');
    return;
  }

  const payload = {
    cotacao_id: cotacaoId,
    token_cotacao: token,
    empresa_nome: empresa,
    responsavel_nome: contato,
    telefone: document.getElementById('forn-tel').value.trim(),
    email: document.getElementById('forn-email').value.trim(),
    total_proposta: total,
    itens_json: products.map(p => ({
      id: p.id,
      produto: p.produto_nome,
      preco: localPrices[p.id] || 0
    }))
  };

  // Grava no banco de dados
  const { error } = await _supabase.from('propostas_fornecedor').insert([payload]);

  if (error) {
    notify('Erro ao enviar para o banco: ' + error.message, 'error');
  } else {
    // Esconde UI e mostra sucesso
    document.getElementById('btn-row').style.display = 'none';
    document.getElementById('success-banner').style.display = 'block';
    
    // Desabilita inputs
    document.querySelectorAll('.input-price').forEach(i => i.disabled = true);
    
    notify('Enviado! O consultor foi avisado.', 'success');
  }
}

function notify(msg, type) {
  const div = document.createElement('div');
  div.className = `notif ${type}`;
  div.textContent = msg;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 4000);
}

// Inicializar
window.onload = loadData;
</script>
</body>
</html>
